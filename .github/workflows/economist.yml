name: Fetch and Process Economist

on:
  schedule:
    - cron: '0 1 * * 6'  # 北京时间周六上午9点
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install beautifulsoup4 lxml requests

      - name: Find latest issue and download
        run: |
          mkdir -p input
          
          # 获取最新文件夹（格式：te_YYYY.MM.DD）
          LATEST_FOLDER=$(curl -s "https://api.github.com/repos/hehonghui/awesome-english-ebooks/contents/01_economist?ref=master" | \
            python3 -c "import sys, json; folders=[i['name'] for i in json.load(sys.stdin) if i['type']=='dir' and i['name'].startswith('te_')]; print(sorted(folders)[-1])")
          
          echo "Latest folder: $LATEST_FOLDER"
          
          # 从文件夹名提取日期（te_2026.02.07 → 2026.02.07）
          DATE_PART=$(echo "$LATEST_FOLDER" | sed 's/te_//')
          echo "Date part: $DATE_PART"
          
          # 构建文件名：TheEconomist.YYYY.MM.DD.epub
          FILENAME="TheEconomist.${DATE_PART}.epub"
          echo "Filename: $FILENAME"
          
          # 构建下载链接
          DOWNLOAD_URL="https://raw.githubusercontent.com/hehonghui/awesome-english-ebooks/master/01_economist/${LATEST_FOLDER}/${FILENAME}"
          echo "Download URL: $DOWNLOAD_URL"
          
          # 下载
          curl -L --fail -o input/economist.epub "$DOWNLOAD_URL"
          
          # 验证
          echo "File size:"
          ls -lh input/economist.epub
          
          # 检查是否为有效 ZIP
          if ! unzip -t input/economist.epub > /dev/null 2>&1; then
            echo "Error: Not a valid ZIP file"
            echo "First 500 bytes:"
            head -c 500 input/economist.epub
            exit 1
          fi
          
          echo "Downloaded and verified successfully"

      - name: Process EPUB
        run: python scripts/process.py

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './output'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
